name: Xacro Smoke Test

on:
  push:
  pull_request:

jobs:
  xacro-test:
    name: Build and Test Xacro
    runs-on: ubuntu-latest
    container:
      image: althack/ros2:humble-dev

    steps:
      - name: Checkout Workspace
        uses: actions/checkout@v5

      - name: Build and Run Checks
        shell: bash
        run: |
          set -e # Bricht bei Fehlern sofort ab
          
          # --- 1. ROS-Umgebung & Abhängigkeiten ---
          source /opt/ros/humble/setup.bash
          sudo apt-get update > /dev/null
          # Der entscheidende Fix: xacro explizit installieren
          sudo apt-get install -y ros-humble-xacro
          rosdep update
          rosdep install --from-paths src --ignore-src -y --rosdistro humble
          
          # --- 2. Workspace bauen ---
          echo "INFO: Building workspace..."
          colcon build
          
          # --- 3. Gebauten Workspace laden & Tests ausführen ---
          echo "INFO: Sourcing local workspace..."
          source install/setup.bash
          
          echo "INFO: Expanding robot.urdf.xacro (sim_mode=false)..."
          xacro src/robot/description/robot.urdf.xacro > robot_non_sim.urdf
          if grep -q "drive_arduino/TB6612HardwareInterface" robot_non_sim.urdf; then
            echo "✅ OK: TB6612HardwareInterface found in non-sim URDF"
          else
            echo "❌ ERROR: TB6612HardwareInterface not found in robot_non_sim.urdf"
            exit 1
          fi
          
          echo "INFO: Expanding robot.urdf.xacro (sim_mode=true)..."
          xacro src/robot/description/robot.urdf.xacro sim_mode:=true > robot_sim.urdf
          if grep -q "gazebo_ros2_control/GazeboSystem" robot_sim.urdf; then
            echo "✅ OK: GazeboSystem found in sim URDF"
          else
            echo "❌ ERROR: GazeboSystem not found in robot_sim.urdf"
            exit 1
          fi